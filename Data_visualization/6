library(tidyverse)
library(ggplot2)


##### Averiguo el total de cada grupo ####
Grupo= group_by(Resultados, Strain) %>% summarise("CantidadTotal"=n()) 

##### Grafico homologas a gallina ####
#agrupo
chicken = group_by(Resultados, ChickenHomologue, Strain) %>% summarise("Amount of Proteins"=n()) 

#Reemplazo por los valores de AgProtect para todas las sp
chicken <- chicken %>%
  mutate(`Amount of Proteins` = case_when(
    `Amount of Proteins` == 363 ~ 377,
    `Amount of Proteins` == 1614 ~ 1600,
    TRUE ~ `Amount of Proteins`  # Keep the original value if no condition matches
  ))

#Agrego el total de cada grupo
chicken = full_join(chicken, Grupo, by="Strain")


#########################Poster

poster <- chicken %>% 
  filter(ChickenHomologue == "Host Homologue") %>% 
  select(Strain, CantidadTotal, "Amount of Proteins") %>% 
  ungroup() 

poster <- select(poster,-"ChickenHomologue")

colnames(poster)[3] <- "Homologas"

poster$NoHomologas <- poster$CantidadTotal - poster$Homologas

poster <- select(poster,-"Homologas")


##### Grafico AntigÃ©nicas ####
#filtro
Antigenics = filter(Resultados, ChickenHomologue ==  "Non Host Homologue")


Ag_COG = group_by(Antigenics, AntigenicityResult, Strain, COG_category_u) %>%
  summarise("Amount of Proteins"=n()) 

#agrupo
Antigenics = group_by(Antigenics, AntigenicityResult, Strain) %>% summarise("Amount of Total Proteins"=n()) 

#limpio
Antigenics = filter(Antigenics, AntigenicityResult != "-")

#Agrego el total de cada grupo
chicken2 = filter(chicken, ChickenHomologue == "Non Host Homologue")
Antigenics = full_join(Antigenics, chicken2, by="Strain")
rm(chicken2)

#acomodo columnas para menos confusion
colnames(Antigenics)[3] = "AntigenicityResultAmount"
colnames(Antigenics)[5] = "AmountOfNonHomologousProteins"

Antigenics=select(Antigenics,-CantidadTotal)

#agrego columna porcentaje
Antigenics$Porcentaje = Antigenics$AntigenicityResultAmount *100 / Antigenics$AmountOfNonHomologousProteins
Antigenics$Porcentaje_antigenics = Antigenics$AntigenicityResultAmount *100 / Grupo$CantidadTotal



#########################Poster

delete <- Antigenics %>%
  filter(ChickenHomologue == "Non Host Homologue", 
         AntigenicityResult == "NON-ANTIGEN") %>%
  select(AntigenicityResultAmount, Strain) %>% 
  ungroup()

poster <- inner_join(poster,delete, by="Strain")

colnames(poster)[4:5] <- c("delete", "NoAntig")

poster$AntigNH <- poster$NoHomologas - poster$NoAntig


poster <- select(poster,-"NoAntig", -"delete")


##### Grafico Exposition ####
#filtro
Exposed = filter(Resultados, AntigenicityResult ==  "ANTIGEN" & 
                   ChickenHomologue ==  "Non Host Homologue")

SL_COG = group_by(Exposed, SubcellularLocalization, Strain, COG_category_u) %>%
  summarise("Amount of Proteins"=n())

#agrupo
Exposed = group_by(Exposed, Exposition, SubcellularLocalization, Strain) %>% summarise("Amount of Proteins"=n()) 

#Agrego el total de cada grupo
Antigenics2 = filter(Antigenics, AntigenicityResult == "ANTIGEN")
Exposed = full_join(Exposed, Antigenics2, by="Strain")
rm(Antigenics2)

#acomodo columnas para menos confusion
Exposed=select(Exposed, SubcellularLocalization, Strain, `Amount of Proteins`, AntigenicityResultAmount, Exposition)

#agrego columna porcentaje
Exposed$Porcentaje = Exposed$`Amount of Proteins` *100 / Exposed$AntigenicityResultAmount
Exposed$Porcentaje_exposed = Exposed$`Amount of Proteins` *100 / Grupo$CantidadTotal

#cambio columna de character a factor
Exposed$SubcellularLocalization = as.factor(Exposed$SubcellularLocalization )


#########################Poster
transformed_data <- Exposed %>%
  filter(SubcellularLocalization %in% c("Extracellular", "OuterMembrane")) %>%  
  group_by(Strain) %>%
  summarise(exposed_proteins = sum(`Amount of Proteins`, na.rm = TRUE))

poster <- inner_join(poster,transformed_data, by="Strain")

poster$ExposAgNH <- poster$AntigNH - poster$exposed_proteins

poster <- select(poster,-"exposed_proteins")




#### Grafico Conservation ####
#filtro

Conserv = filter(Resultados, AntigenicityResult ==  "ANTIGEN", 
                 ChickenHomologue ==  "Non Host Homologue", 
                 SubcellularLocalization == "Extracellular" |  SubcellularLocalization == "OuterMembrane" )

Cons_COG = group_by(Conserv, ConsDef, Strain, COG_category_u) %>%
  summarise("Amount of Proteins"=n())

#agrupo
Conserv1 = group_by(Conserv, ConsDef, Strain) %>% summarise("Amount of Proteins"=n()) 
Conserv2= group_by(Conserv, Strain) %>% summarise("TotalProteins"=n()) 

Conserv = full_join(Conserv1, Conserv2, by="Strain")
rm(Conserv1, Conserv2)


#agrego columna porcentaje
Conserv$Porcentaje = Conserv$`Amount of Proteins` *100 / Conserv$TotalProteins





#########################Poster
transformed_data <- Conserv %>%
  filter(ConsDef %in% c("Conservation Score > 0.95, more than 48 strains", 
                        "Conservation Score > 0.80, more than 48 strains")) %>%  
  group_by(Strain) %>%
  summarise(Conservas = sum(`Amount of Proteins`, na.rm = TRUE))

poster <- inner_join(poster,transformed_data, by="Strain")




rm(n)

rm(Ag_COG,Antigenics,chicken, Cons_COG, Conserv, delete, Exposed, Grupo,
   SL_COG, transformed_data, JJ)



poster <- poster %>%
  bind_rows(
    poster %>%  
      filter(Strain != "Experimental Antigens") %>%    
      select(-Strain) %>%
      summarise(across(everything(), ~ round(mean(.x, na.rm = TRUE), 0))) %>%   
      mutate(Strain = "Mean")             
  )


colnames(poster)[2:6] = c("Total\nProteins", "Homology\nwith Host", "Antigenicity",
                          "Subcellular\nLocalization","Conservation")



poster_Ag <- poster %>%
  filter(Strain=="Experimental Antigens")

poster_m <- poster %>%
  filter(Strain=="Mean")

poster1 <- poster %>%
  filter(Strain!="Experimental Antigens") %>%
  filter(Strain!="Mean")



# Assuming both datasets have the same structure
poster1$group <- "Av. paragallinarum individual strains"
poster_Ag$group <- "Experimental Antigens"
poster_m$group <- "Mean of Av. paragallinarum strains"

# Combine the two datasets into one
poster <- rbind(poster1, poster_Ag, poster_m)

rm(poster1,poster_m,poster_Ag)

# Make sure the 'group' column is a factor
poster$group <- as.factor(poster$group)

poster$alphaLevel <- c("Av. paragallinarum individual strains" = 0.15,
                       "Experimental Antigens" = 1, 
                       "Mean of Av. paragallinarum strains" = 1)[poster$group]

poster <- poster %>%
  mutate(Conservation = if_else(Strain == "Experimental Antigens",
                                689, 
                                Conservation))


grob <- grobTree(textGrob("*", x=0.89,  y=0.27, hjust=0,
                          gp=gpar(col="orangered3", fontsize=18, fontface="bold")))

poster$labelss <- c("Av. paragallinarum individual strains" = "*Av. paragallinarum* individual strains",
                    "Experimental Antigens" = "Experimental Antigens", 
                    "Mean of Av. paragallinarum strains" = "Mean of *Av. paragallinarum* strains")[poster$group]


# Plot combined data using ggparcoord
ggparcoord(poster,
           columns = 2:6,  
           groupColumn = "labelss", 
           scale = "globalminmax",
           alphaLines = "alphaLevel",
           showPoints = TRUE,
           mapping = ggplot2::aes(linewidth = 1.5)
) +
  ggplot2::scale_linewidth_identity() +
  scale_color_manual(values = c("deepskyblue", "orangered3","navyblue"))  +
  theme(axis.text.x=element_text(colour="black"),
        axis.text.y=element_text(colour="black"),
        text = element_text(family = "Times New Roman", size = 32), 
        panel.background = element_rect(fill='transparent'),
        plot.background = element_rect(fill='transparent', color=NA),
        panel.grid.minor = element_blank(),
        legend.background = element_rect(fill='transparent'),
        panel.grid.major = element_line(colour = "grey", linetype = "dotted", 
                                        linewidth = 0.3),
        legend.position = "inside",
        legend.position.inside = c(0.70,0.88),
        legend.text = element_markdown(size = 25),
        legend.title = element_blank()) + 
  labs(y = "Number of proteins",
       x = "") + 
  annotation_custom(grob) +
  guides(alpha="none")

ggsave("6.png", device = "png", path = "~/Desktop/Graficos", 
       width =4000, height = 2500, units="px", bg='transparent')

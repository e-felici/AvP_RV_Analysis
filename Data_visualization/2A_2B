# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(ggpubr) 
library(patchwork)

#Define paths
load("~/bin/bin/RScripts/Paper1/Paper1_workspace_Definitivo.RData")
output_path <- "~/Desktop/Graficos"

#Remove underscore
Results$Strain <- str_replace_all(Results$Strain,
                                  "Experimental_Antigens",
                                  "Experimental Antigens")

# Find total number of proteins per strain
Strain_number = group_by(Results, Strain) %>% summarise("Total_Number_of_proteins_per_Strain"=n()) 

# Select relevant columns and group by Strain and COG_category_u, then summarize
COG <- Results %>%
  select(ID, COG_category_u, Strain) %>%
  group_by(Strain, COG_category_u) %>%
  summarise(Total_Number_of_proteins_COG = n()) %>%
  full_join(Strain_number, by = "Strain")

##### Figure 2A
# Create and polish Host Homologue tibble
Host <- Results %>%
  group_by(Host_Homologue_Result_All, Strain) %>%
  summarise(Amount_of_Host_Homologue_Proteins = n()) %>%
  full_join(Strain_number, by = "Strain") %>%
  mutate(Percentage_Host = Amount_of_Host_Homologue_Proteins * 100 / Total_Number_of_proteins_per_Strain)

# Calculate the mean percentage of non-host homologue proteins
Mean_Percentage_Host <- Host %>%
  filter(Host_Homologue_Result_All == "Non Host Homologue", 
         Strain != "Experimental Antigens") %>%
  summarise(mean_percentage = round(mean(Percentage_Host), digits = 2)) %>%
  pull(mean_percentage)

# Create the first plot (Figure 2A)
p2A <- ggplot(Host, aes(fill=Host_Homologue_Result_All, y=Percentage_Host, x=Strain)) + 
  geom_bar(position="stack", stat="identity", show.legend = FALSE) + 
  scale_fill_manual(values =c("#9e2f28","#e1ccd1","olivedrab")) +
  theme(axis.title = element_text(family = "Times New Roman", size=16, color = "black"), 
        title = element_text(family = "Times New Roman", size=16, color = "black"), 
        text = element_text(family = "Times New Roman", size = 16, color = "black"),
        axis.text = element_text(family = "Times New Roman", size = 11, color = "black"),
        panel.background =  element_rect(fill = "white"), 
        panel.grid.major = element_line(colour = "grey", linetype = "dotted", 
                                        linewidth = 0.3)
        ) +
  coord_flip() + 
  labs(y = "Percentage of proteins",
       tag = "2A") +
  geom_hline(yintercept = Mean_Percentage_Host, color = "blue") 

p2A


#######Figure 2B
#Create Host and COG tibble
Host_COG <- Results %>%
  group_by(Host_Homologue_Result_All, Strain, COG_category_u) %>%
  summarise(Total_Number_of_proteins_Host_COG = n()) %>%
  full_join(COG, by = c("Strain", "COG_category_u")) %>%
  mutate(Percentage_Host_COG = Total_Number_of_proteins_Host_COG * 100 / Total_Number_of_proteins_per_Strain) %>%
  filter(!str_starts(Strain, "Exp"))


# Calculate the mean percentage of host homologue proteins per COG category
means_Host_COG <- Host_COG %>%
  group_by(COG_category_u,Host_Homologue_Result_All) %>%
  summarize(mean_value = mean(Percentage_Host_COG))

# Create the second plot (Figure 2B)
p2B <- ggplot(means_Host_COG, aes(fill=Host_Homologue_Result_All, 
                                  y=mean_value, x=COG_category_u)) + 
  geom_bar(position="stack", stat="identity") + 
  scale_fill_manual(values =c("#9e2f28","olivedrab")) +
  theme(axis.title = element_text(family = "Times New Roman"), 
        axis.text = element_text(family = "Times New Roman", size = 16, color = "black"),
        title = element_text(family = "Times New Roman"), 
        legend.title=element_blank(),
        legend.position="bottom",
        text = element_text(family = "Times New Roman", size = 16), 
        panel.background =  element_rect(fill = "white"), 
        panel.grid.major = element_line(colour = "grey", linetype = "dotted", 
                                        linewidth = 0.3)) + 
  labs(y = "Mean for all strains", 
       x = "COG category",
       tag = "2B")

p2B

# Arrange the two plots side by side
ggarrange(p2A, p2B, 
          ncol = 2, nrow = 1)

# Save the combined plot as a PNG file
ggsave("2A&B.png", device = "png", path = output_path, 
       width =3800, height = 3000, units="px")
